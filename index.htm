<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ramadan Quiz Game üåô</title>
  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#141b2f;
      --card:#101a33cc;
      --card2:#0e1630e6;
      --text:#f5f7ff;
      --muted:#b8c0ff;
      --accent:#ffd166;
      --accent2:#6ee7ff;
      --good:#22c55e;
      --bad:#ef4444;
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius: 22px;
      --btn: #1a2752;
      --btnHover: #22336a;
      --ring: rgba(110,231,255,.35);
      --font: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(255,209,102,.18), transparent 55%),
        radial-gradient(900px 700px at 85% 20%, rgba(110,231,255,.14), transparent 55%),
        radial-gradient(900px 900px at 60% 120%, rgba(168,85,247,.10), transparent 55%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      overflow-x:hidden;
    }

    body:before{
      content:"";
      position:fixed; inset:0;
      background:
        radial-gradient(circle at 30px 30px, rgba(255,255,255,.05) 0 2px, transparent 3px) 0 0/40px 40px;
      opacity:.25;
      pointer-events:none;
      mix-blend-mode:overlay;
    }

    .app{
      width:min(980px, 100%);
      display:grid;
      gap:14px;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 16px;
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(16,26,51,.72), rgba(14,22,48,.55));
      box-shadow: var(--shadow);
      border:1px solid rgba(255,255,255,.07);
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 220px;
    }

    .logo{
      width:44px; height:44px;
      border-radius:14px;
      display:grid; place-items:center;
      background: radial-gradient(circle at 30% 30%, rgba(255,209,102,.35), rgba(110,231,255,.10)),
                  linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
    }

    .brand h1{
      font-size:18px;
      margin:0;
      letter-spacing:.2px;
      line-height:1.2;
    }
    .brand p{
      margin:0;
      font-size:12px;
      color:var(--muted);
    }

    .top-controls{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--text);
      font-size:13px;
      user-select:none;
      white-space:nowrap;
    }

    .pill strong{color:var(--accent)}
    .toggle{
      cursor:pointer;
      outline:none;
      border:none;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      padding:10px 12px;
      border-radius:999px;
      color:var(--text);
      font-size:13px;
      display:flex;
      align-items:center;
      gap:8px;
      transition:.15s transform, .15s background;
      text-decoration:none;
      white-space:nowrap;
    }
    .toggle:hover{ background: rgba(255,255,255,.10); transform: translateY(-1px); }
    .toggle:active{ transform: translateY(0px) scale(.99); }

    .card{
      position:relative;
      padding:18px;
      border-radius:var(--radius);
      background: linear-gradient(180deg, rgba(16,26,51,.75), rgba(14,22,48,.62));
      border:1px solid rgba(255,255,255,.08);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
      min-height: 520px;
      display:grid;
      grid-template-rows: auto auto 1fr auto;
      gap:14px;
    }

    .progress-wrap{
      display:grid;
      gap:8px;
    }
    .progress-line{
      height:12px;
      background: rgba(255,255,255,.08);
      border-radius:999px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
    }
    .progress-bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(255,209,102,.95), rgba(110,231,255,.95));
      border-radius:999px;
      transition: width .35s ease;
      box-shadow: 0 0 0 6px rgba(110,231,255,.08) inset;
    }
    .meta-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    .lesson-tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background: rgba(110,231,255,.10);
      border: 1px solid rgba(110,231,255,.20);
      color: #eaffff;
      font-size:13px;
      white-space:nowrap;
    }
    .difficulty{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background: rgba(255,209,102,.10);
      border: 1px solid rgba(255,209,102,.22);
      color:#fff7e3;
      font-size:13px;
      white-space:nowrap;
    }

    .qwrap{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
      align-items:start;
    }

    .qbox{
      display:grid;
      gap:10px;
      padding:14px;
      border-radius:18px;
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.10);
    }

    .qtitle{
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    .icon{
      width:54px; height:54px;
      flex:0 0 auto;
      border-radius:16px;
      display:grid;
      place-items:center;
      background:
        radial-gradient(circle at 25% 25%, rgba(255,209,102,.35), rgba(110,231,255,.12)),
        linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 12px 26px rgba(0,0,0,.25);
    }
    .qtext{
      margin:0;
      font-size:22px;
      line-height:1.55;
      letter-spacing:.15px;
    }
    .qhint{
      margin:0;
      color: var(--muted);
      font-size:13px;
    }

    .answers{
      display:grid;
      gap:12px;
      grid-template-columns: 1fr;
      margin-top:8px;
    }

    .btn{
      width:100%;
      text-align:left;
      border:none;
      outline:none;
      cursor:pointer;
      padding:16px 16px;
      border-radius:16px;
      background: linear-gradient(180deg, rgba(26,39,82,.95), rgba(15,25,56,.95));
      color: var(--text);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 12px 26px rgba(0,0,0,.22);
      font-size:18px;
      line-height:1.3;
      transition: transform .12s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
      position:relative;
      overflow:hidden;
      min-height: 58px;
    }
    .btn:hover{
      background: linear-gradient(180deg, rgba(34,51,106,.98), rgba(17,28,63,.96));
      transform: translateY(-1px);
      box-shadow: 0 16px 30px rgba(0,0,0,.26);
      border-color: rgba(110,231,255,.25);
    }
    .btn:active{ transform: translateY(0px) scale(.995); }

    .btn .choiceLabel{
      display:inline-flex;
      width:34px;
      height:34px;
      align-items:center;
      justify-content:center;
      border-radius:12px;
      margin-right:10px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.92);
      font-weight:700;
    }

    .btn.good{
      border-color: rgba(34,197,94,.55);
      box-shadow: 0 0 0 6px rgba(34,197,94,.12), 0 18px 38px rgba(0,0,0,.28);
      background: linear-gradient(180deg, rgba(34,197,94,.22), rgba(16,52,38,.40));
    }
    .btn.bad{
      border-color: rgba(239,68,68,.55);
      box-shadow: 0 0 0 6px rgba(239,68,68,.10), 0 18px 38px rgba(0,0,0,.28);
      background: linear-gradient(180deg, rgba(239,68,68,.20), rgba(60,18,18,.40));
    }

    .footer{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      padding-top:6px;
      border-top:1px dashed rgba(255,255,255,.12);
    }

    .small{
      font-size:12px;
      color: var(--muted);
      line-height:1.5;
    }

    .primary{
      cursor:pointer;
      border:none;
      outline:none;
      padding:12px 14px;
      border-radius:14px;
      color:#08111f;
      font-weight:800;
      background: linear-gradient(90deg, rgba(255,209,102,.98), rgba(110,231,255,.92));
      box-shadow: 0 16px 30px rgba(0,0,0,.24);
      transition: transform .12s ease;
      display:inline-flex;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    .primary:hover{ transform: translateY(-1px); }
    .primary:active{ transform: translateY(0px) scale(.99); }

    .overlay{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      background: radial-gradient(circle at 50% 30%, rgba(255,255,255,.10), rgba(0,0,0,.35));
      backdrop-filter: blur(6px);
      z-index: 5;
    }
    .overlay.show{ display:flex; }

    .modal{
      width:min(720px, 100%);
      background: linear-gradient(180deg, rgba(16,26,51,.92), rgba(14,22,48,.90));
      border:1px solid rgba(255,255,255,.12);
      border-radius: 24px;
      box-shadow: 0 22px 70px rgba(0,0,0,.45);
      padding:18px;
      display:grid;
      gap:14px;
    }
    .modal h2{ margin:0; font-size:24px; }
    .modal p{ margin:0; color: var(--muted); line-height:1.6; white-space:pre-line; }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 720px){
      .grid2{ grid-template-columns: 1fr; }
      .qtext{ font-size:20px; }
      .btn{ font-size:17px; min-height:56px; }
      header{ padding:12px; }
      .brand{ min-width:auto; }
    }

    .sparkle{
      position:absolute;
      width:10px; height:10px;
      border-radius:50%;
      background: radial-gradient(circle, rgba(255,255,255,1), rgba(255,255,255,0));
      filter: drop-shadow(0 0 10px rgba(255,209,102,.65));
      pointer-events:none;
      opacity:0;
      animation: pop 900ms ease forwards;
    }
    @keyframes pop{
      0%{ transform: translate(0,0) scale(.4); opacity:0; }
      20%{ opacity:1; }
      100%{ transform: translate(var(--dx), var(--dy)) scale(1.2); opacity:0; }
    }

    canvas#fx{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index: 10;
    }

    .card:after{
      content:"";
      position:absolute;
      inset:-120px;
      background: radial-gradient(circle at 30% 20%, rgba(110,231,255,.18), transparent 45%),
                  radial-gradient(circle at 80% 10%, rgba(255,209,102,.12), transparent 45%),
                  radial-gradient(circle at 55% 80%, rgba(34,197,94,.10), transparent 45%);
      opacity:.55;
      pointer-events:none;
    }
    .card > *{ position:relative; z-index:1; }

    .kbd{
      font-size:12px;
      padding:3px 7px;
      border-radius:8px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.85);
      display:inline-block;
    }
  </style>
</head>
<body>
<canvas id="fx"></canvas>

<div class="app" role="application" aria-label="Educational quiz game">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true">üåô</div>
      <div>
        <h1>Ramadan Quiz Game</h1>
        <p>Multiple Choice ‚Ä¢ Read the PDF first</p>
      </div>
    </div>

    <div class="top-controls">
      <div class="pill" title="Progress">
        Question: <strong id="qIndex">0</strong>/<span id="qTotal">0</span>
      </div>
      <div class="pill" title="Score">
        Score: <strong id="score">0</strong>
      </div>

      <!-- ‚úÖ Works in file:// and on GitHub Pages -->
      <button class="toggle" id="pdfBtn" type="button" title="Open the PDF before playing">
        üìÑ <span>Open PDF</span>
      </button>

      <button class="toggle" id="musicBtn" type="button" aria-pressed="false" title="Toggle music">
        üéµ <span id="musicLabel">Music: Off</span>
      </button>
      <button class="toggle" id="sfxBtn" type="button" aria-pressed="true" title="Toggle sound effects">
        üîä <span id="sfxLabel">SFX: On</span>
      </button>
      <button class="toggle" id="helpBtn" type="button" title="Help">
        ‚ùî Help
      </button>
    </div>
  </header>

  <main class="card">
    <div class="progress-wrap">
      <div class="meta-row">
        <div class="lesson-tag" id="lessonTag">üìò Lesson</div>
        <div class="difficulty" id="diffTag">‚≠ê Easy</div>
      </div>
      <div class="progress-line" aria-label="Progress bar">
        <div class="progress-bar" id="progressBar"></div>
      </div>
    </div>

    <section class="qwrap" aria-live="polite">
      <div class="qbox">
        <div class="qtitle">
          <div class="icon" id="qIcon" aria-hidden="true"></div>
          <div>
            <p class="qtext" id="qText">Press ‚ÄúStart Game‚Äù to begin!</p>
            <p class="qhint" id="qHint">Tip: Open the PDF first, then start ‚úÖ</p>
          </div>
        </div>

        <div class="answers" id="answers"></div>
      </div>
    </section>

    <div class="footer">
      <div class="small">
        Keyboard: <span class="kbd">1</span> <span class="kbd">2</span> <span class="kbd">3</span> <span class="kbd">4</span> to answer ‚Ä¢
        <span class="kbd">M</span> music ‚Ä¢ <span class="kbd">S</span> SFX
      </div>
      <button class="primary" id="startBtn" type="button">üöÄ Start Game</button>
    </div>

    <div class="overlay" id="overlay">
      <div class="modal" role="dialog" aria-modal="true" aria-label="Dialog">
        <h2 id="modalTitle">Help</h2>
        <p id="modalText"></p>
        <div class="grid2">
          <button class="primary" id="closeModalBtn" type="button">‚úÖ Got it</button>
          <button class="toggle" id="restartBtn" type="button">üîÅ Restart</button>
        </div>
      </div>
    </div>
  </main>
</div>

<script>
/* =========================================================
   0) PDF URL (Google Drive)
   ========================================================= */
const PDF_URL = "https://drive.google.com/file/d/1pOn38imJnU9I0D7FGuxzikAUF87Xw-HB/view?usp=drive_link";

/* =========================================================
   1) Question Bank (30) ‚Äî from Ramadan Protocol.pdf only
   ========================================================= */
const QUESTIONS = [
  // The Lunar Calendar (p.2)
  { lesson:"The Lunar Calendar", icon:"moon", difficulty:"Easy",
    q:"Ramadan is the ____ month in the Islamic calendar.",
    choices:["9th","1st","12th","6th"], answerIndex:0 },
  { lesson:"The Lunar Calendar", icon:"moon", difficulty:"Easy",
    q:"Why do Ramadan dates change every year compared to the solar calendar?",
    choices:["Because it follows the lunar calendar","Because it always starts on Friday","Because it is fixed like the solar calendar","Because it does not follow any calendar"], answerIndex:0 },
  { lesson:"The Lunar Calendar", icon:"crescent", difficulty:"Medium",
    q:"According to the file, what signal marks the beginning and end of the month?",
    choices:["Seeing the crescent (Hilal) with the naked eye","Sunrise","Rain","Changing the clock"], answerIndex:0 },
  { lesson:"The Lunar Calendar", icon:"spark", difficulty:"Thinking",
    q:"Which statement matches the file‚Äôs key insight about Ramadan?",
    choices:["A time for spiritual reflection, self-improvement, and increased devotion","A time only for sports","A time to sleep all day","A time to stop praying"], answerIndex:0 },

  // The Revelation (Al-Wahyu) (p.3)
  { lesson:"The Revelation (Al-Wahyu)", icon:"quran", difficulty:"Easy",
    q:"Who revealed the words of Allah (the Qur‚Äôan) to Prophet Muhammad, according to the file?",
    choices:["Angel Jibril (Gabriel)","Prophet Adam","Israfil","An unknown person"], answerIndex:0 },
  { lesson:"The Revelation (Al-Wahyu)", icon:"quran", difficulty:"Medium",
    q:"What is the main reason mentioned for Ramadan being a holy month?",
    choices:["The Qur‚Äôan was revealed to Prophet Muhammad","It is always in summer","It is the longest month","There is no fasting in it"], answerIndex:0 },
  { lesson:"The Revelation (Al-Wahyu)", icon:"book", difficulty:"Medium",
    q:"According to the file, the Qur‚Äôan was sent as what for humanity?",
    choices:["Guidance","A fairy tale","A game","Traffic rules"], answerIndex:0 },
  { lesson:"The Revelation (Al-Wahyu)", icon:"gate", difficulty:"Thinking",
    q:"Which option matches the metaphysical changes described in the file for Ramadan?",
    choices:["The gates of Paradise open and the gates of Hell close","The gates of Paradise close and the gates of Hell open","No changes happen","All gates close"], answerIndex:0 },

  // Sawm: The Physical Protocol (p.4)
  { lesson:"Sawm: The Physical Protocol", icon:"nofood", difficulty:"Easy",
    q:"In the file‚Äôs definition, fasting (Sawm) means completely abstaining from what?",
    choices:["Food, drink, and intimacy","Reading only","Sleeping only","Walking only"], answerIndex:0 },
  { lesson:"Sawm: The Physical Protocol", icon:"clock", difficulty:"Easy",
    q:"According to the file, what is the timeframe for fasting?",
    choices:["From dawn to sunset","From noon to afternoon","From sunset to dawn","For 24 hours"], answerIndex:0 },
  { lesson:"Sawm: The Physical Protocol", icon:"map", difficulty:"Medium",
    q:"Why does fasting duration vary, according to the file?",
    choices:["It depends on geographical location and season","It depends on clothing color","It depends on phone type","It never varies"], answerIndex:0 },
  { lesson:"Sawm: The Physical Protocol", icon:"hours", difficulty:"Medium",
    q:"The file states fasting hours can range approximately between:",
    choices:["12 and 17 hours","1 and 3 hours","20 and 23 hours","5 and 6 hours only"], answerIndex:0 },

  // Sawm: The Spiritual Protocol (p.5)
  { lesson:"Sawm: The Spiritual Protocol", icon:"heart", difficulty:"Easy",
    q:"What is the objective of fasting mentioned in the file?",
    choices:["Purification of the soul","Raising your voice","Collecting money","Forgetting all behaviors"], answerIndex:0 },
  { lesson:"Sawm: The Spiritual Protocol", icon:"mind", difficulty:"Medium",
    q:"According to the file‚Äôs behavioral rules, a person should avoid:",
    choices:["Negative thoughts and actions","Drinking water after Maghrib","Kind speech","Helping others"], answerIndex:0 },
  { lesson:"Sawm: The Spiritual Protocol", icon:"stop", difficulty:"Medium",
    q:"According to the file‚Äôs specific prohibitions, what is forbidden at all times?",
    choices:["Bad language, idle talk, and harmful behavior","Smiling","Being calm","Reading the Qur‚Äôan"], answerIndex:0 },
  { lesson:"Sawm: The Spiritual Protocol", icon:"gift", difficulty:"Thinking",
    q:"What reward does the file mention for fasting with full faith and obedience?",
    choices:["Sins are forgiven","Fasting becomes shorter","No sleep is needed","Weekdays change"], answerIndex:0 },

  // Who Observes the Fast? (p.6)
  { lesson:"Who Observes the Fast?", icon:"people", difficulty:"Easy",
    q:"What general rule does the file state about fasting in Ramadan?",
    choices:["All Muslims are expected to fast","No one fasts","Only children fast","Only travelers fast"], answerIndex:0 },
  { lesson:"Who Observes the Fast?", icon:"child", difficulty:"Medium",
    q:"Which group is listed as an exemption in the file?",
    choices:["Children","People who eat at iftar","People who read the Qur‚Äôan","People who pray Maghrib"], answerIndex:0 },
  { lesson:"Who Observes the Fast?", icon:"health", difficulty:"Medium",
    q:"The file mentions exemptions for adults who are not healthy in what way?",
    choices:["Mentally or physically","Only because of boredom","Only because it is hot","Only because of school"], answerIndex:0 },
  { lesson:"Who Observes the Fast?", icon:"travel", difficulty:"Medium",
    q:"Which is listed as an exemption in the file?",
    choices:["Adults traveling long distances","Teachers only","People who pray Taraweeh","People who eat Sahoor"], answerIndex:0 },
  { lesson:"Who Observes the Fast?", icon:"pregnant", difficulty:"Medium",
    q:"Which group is listed as an exemption in the file?",
    choices:["Pregnant women","Top students","People who like dates","People who sleep early"], answerIndex:0 },

  // The Morning Cycle: Sahoor (p.7)
  { lesson:"The Morning Cycle: Sahoor", icon:"sunrise", difficulty:"Easy",
    q:"What is Sahoor according to the file?",
    choices:["A pre-dawn meal","A meal after sunset","A midnight-only meal","A meal after noon"], answerIndex:0 },
  { lesson:"The Morning Cycle: Sahoor", icon:"battery", difficulty:"Easy",
    q:"What is the purpose of Sahoor mentioned in the file?",
    choices:["It provides energy for the upcoming day","It prevents sleep forever","It makes fasting shorter","It replaces iftar"], answerIndex:0 },
  { lesson:"The Morning Cycle: Sahoor", icon:"fajr", difficulty:"Medium",
    q:"When does Sahoor take place according to the file?",
    choices:["Before the first prayer of the day (Fajr)","After Maghrib prayer","After Isha prayer","After Asr prayer"], answerIndex:0 },

  // The Evening Cycle: Iftar (p.8)
  { lesson:"The Evening Cycle: Iftar", icon:"plate", difficulty:"Easy",
    q:"What does Iftar mean in the file?",
    choices:["Breaking the fast","Starting the fast","The Sahoor meal","Taraweeh prayer"], answerIndex:0 },
  { lesson:"The Evening Cycle: Iftar", icon:"sunset", difficulty:"Easy",
    q:"When does Iftar happen according to the file?",
    choices:["Exactly at sunset","At sunrise","At noon","Right after Fajr"], answerIndex:0 },
  { lesson:"The Evening Cycle: Iftar", icon:"maghrib", difficulty:"Medium",
    q:"Iftar coincides with which prayer in the file‚Äôs spiritual connection?",
    choices:["Maghrib (the 4th daily prayer)","Fajr","Dhuhr","Asr"], answerIndex:0 },
  { lesson:"The Evening Cycle: Iftar", icon:"community", difficulty:"Thinking",
    q:"What idea does the file highlight about Iftar?",
    choices:["The communal aspect of eating together","Staying away from people","Not sharing food","Sleeping instead of eating"], answerIndex:0 },

  // The Night Cycle: Devotion (p.9)
  { lesson:"The Night Cycle: Devotion", icon:"prayer", difficulty:"Easy",
    q:"What is Taraweeh according to the file?",
    choices:["Extra prayers performed at the beginning of the night","A pre-dawn meal","A school reading activity","A celebration after Ramadan"], answerIndex:0 },
  { lesson:"The Night Cycle: Devotion", icon:"clockNight", difficulty:"Medium",
    q:"The file states Taraweeh is typically performed around:",
    choices:["8:00‚Äì9:00 PM","5:00‚Äì6:00 AM","12:00‚Äì1:00 PM","3:00‚Äì4:00 PM"], answerIndex:0 },
  { lesson:"The Night Cycle: Devotion", icon:"read", difficulty:"Easy",
    q:"What does Qiraat mean in the file?",
    choices:["Reading the Qur‚Äôan in free time","Reading newspapers only","Reading only fiction stories","Writing homework only"], answerIndex:0 },
  { lesson:"The Night Cycle: Devotion", icon:"last10", difficulty:"Medium",
    q:"What is Qiam according to the file?",
    choices:["Night prayers performed especially in the last 10 days","Maghrib prayer","The iftar meal","Seeing the new crescent"], answerIndex:0 },

  // Laylat Al Qadr (p.10)
  { lesson:"Laylat Al Qadr", icon:"power", difficulty:"Easy",
    q:"How does the file describe Laylat Al Qadr?",
    choices:["The holiest night of the year","The shortest night of the year","A night when nothing happens","A night only for Sahoor"], answerIndex:0 },
  { lesson:"Laylat Al Qadr", icon:"calendar", difficulty:"Medium",
    q:"The file says it is widely believed to fall on which night of Ramadan?",
    choices:["The 27th night","The 1st night","The 15th night","Always the 30th night"], answerIndex:0 },
  { lesson:"Laylat Al Qadr", icon:"value", difficulty:"Medium",
    q:"What value does the file give for Laylat Al Qadr?",
    choices:["Better than a thousand months","Better than one week","Better than one day","Better than one month only"], answerIndex:0 },
  { lesson:"Laylat Al Qadr", icon:"angels", difficulty:"Thinking",
    q:"According to the file‚Äôs atmosphere description, what happens on this night?",
    choices:["Angels and the Spirit descend by Allah‚Äôs permission","Prayers stop","The crescent disappears","The gates of Paradise close"], answerIndex:0 },
  { lesson:"Laylat Al Qadr", icon:"dawn", difficulty:"Medium",
    q:"The file says peace lasts until:",
    choices:["The emergence of dawn","Sunset","Noon","The end of the month"], answerIndex:0 },

  // The Conclusion: Eid Al-Fitr (p.11)
  { lesson:"The Conclusion: Eid Al-Fitr", icon:"celebrate", difficulty:"Easy",
    q:"When does Eid Al-Fitr take place according to the file?",
    choices:["After Ramadan ends","On the first day of Ramadan","In the middle of Ramadan","Before seeing the crescent"], answerIndex:0 },
  { lesson:"The Conclusion: Eid Al-Fitr", icon:"meaning", difficulty:"Medium",
    q:"What does Eid Al-Fitr mean in the file?",
    choices:["Celebrating the completion of Ramadan and breaking the fast","Celebrating canceling the fast","Celebrating changing time","Celebrating longer fasting hours"], answerIndex:0 },
  { lesson:"The Conclusion: Eid Al-Fitr", icon:"greet", difficulty:"Easy",
    q:"Which greeting is mentioned in the file?",
    choices:["Eid Mubarak!","Good morning!","Hello!","Thank you!"], answerIndex:0 },

  // Ramadan Challenge (p.12‚Äì14)
  { lesson:"Ramadan Challenge: Origins", icon:"cave", difficulty:"Medium",
    q:"Where does the file say the Qur‚Äôan first came down?",
    choices:["Cave of Hira","The Kaaba","Cave of Thaur","An unknown place"], answerIndex:0 },
  { lesson:"Ramadan Challenge: Origins", icon:"night", difficulty:"Medium",
    q:"On which night does the file say the Qur‚Äôan first came down (in the challenge section)?",
    choices:["Laylat al Qadr","Eid night","Taraweeh night","Sahoor night"], answerIndex:0 },
  { lesson:"Ramadan Challenge: History", icon:"history", difficulty:"Medium",
    q:"How many years did Prophet Muhammad spread the message of Islam, according to the file?",
    choices:["23 years","10 years","40 years","5 years"], answerIndex:0 },
  { lesson:"Ramadan Challenge: History", icon:"angel", difficulty:"Easy",
    q:"Who revealed the Qur‚Äôan to Prophet Muhammad, according to the challenge question in the file?",
    choices:["Jibreel","Adam","Israfil","Someone else"], answerIndex:0 },
  { lesson:"Ramadan Challenge: Celebration", icon:"eid", difficulty:"Easy",
    q:"Which Eid comes after Ramadan, according to the file?",
    choices:["Eid al Fitr","Eid al Adha","Hajj","No Eid"], answerIndex:0 },
];

/* =========================================================
   2) Inline educational icons (SVG) ‚Äî no external assets
   ========================================================= */
const ICONS = {
  moon: svg(`<path d="M14 4c-3 3-4 8-2 12s6 6 10 5c-5 4-13 1-15-5S8 6 14 4z"/>`),
  crescent: svg(`<path d="M20 6c-4 2-6 7-4 12s7 6 12 4c-6 4-15 1-17-6S14 6 20 6z"/>`),
  spark: svg(`<path d="M16 2l2 7 7 2-7 2-2 7-2-7-7-2 7-2 2-7z"/>`),
  quran: svg(`<path d="M10 6h12a3 3 0 013 3v13a3 3 0 01-3 3H10a3 3 0 01-3-3V9a3 3 0 013-3zm0 0v20" /><path d="M14 11h8M14 15h8M14 19h6"/>`),
  book: svg(`<path d="M9 5h10a4 4 0 014 4v16H13a4 4 0 00-4 4V5z"/><path d="M9 5v24a4 4 0 014-4h10"/>`),
  gate: svg(`<path d="M8 12V8a8 8 0 0116 0v4"/><path d="M7 12h18v16H7z"/><path d="M16 20v4"/>`),
  nofood: svg(`<path d="M10 7h12v4H10z"/><path d="M12 11v14h8V11"/><path d="M7 7l20 20"/>`),
  clock: svg(`<circle cx="16" cy="16" r="10"/><path d="M16 10v7l5 3"/>`),
  map: svg(`<path d="M8 6l6 2 6-2 4 2v18l-4-2-6 2-6-2-4 2V8z"/>`),
  hours: svg(`<path d="M8 14h16"/><path d="M10 10h12"/><path d="M12 18h8"/><path d="M14 22h4"/>`),
  heart: svg(`<path d="M16 28s-10-6-10-14a6 6 0 0110-3 6 6 0 0110 3c0 8-10 14-10 14z"/>`),
  mind: svg(`<path d="M14 7a5 5 0 019 3v3a4 4 0 01-2 3v3a4 4 0 01-4 4h-2"/><path d="M12 9a4 4 0 00-4 4v1a3 3 0 002 3v4a4 4 0 004 4"/>`),
  stop: svg(`<path d="M11 6h10l5 5v10l-5 5H11l-5-5V11z"/><path d="M12 12h8v8h-8z"/>`),
  gift: svg(`<path d="M8 14h16v14H8z"/><path d="M16 14v14"/><path d="M8 14h16v-4H8z"/><path d="M16 10c-2-5-6-3-6 0 0 2 3 4 6 4m0-4c2-5 6-3 6 0 0 2-3 4-6 4"/>`),
  people: svg(`<path d="M10 16a4 4 0 108 0 4 4 0 10-8 0z"/><path d="M4 28c1-6 7-8 12-8s11 2 12 8"/>`),
  child: svg(`<path d="M12 14a4 4 0 118 0 4 4 0 01-8 0z"/><path d="M8 28c1-5 4-7 8-7s7 2 8 7"/>`),
  health: svg(`<path d="M16 28s-9-6-9-14a5 5 0 019-2 5 5 0 019 2c0 8-9 14-9 14z"/><path d="M16 12v8"/><path d="M12 16h8"/>`),
  travel: svg(`<path d="M4 20l24-6-6 24-5-9-9-5z"/><path d="M18 30l2-7"/>`),
  pregnant: svg(`<path d="M18 10a3 3 0 10-6 0 3 3 0 006 0z"/><path d="M12 28c0-7 2-10 6-10s6 3 6 10"/><path d="M16 18c-2 0-4 2-4 5 0 4 4 6 8 6"/>`),
  sunrise: svg(`<path d="M6 20a10 10 0 0120 0"/><path d="M16 6v6"/><path d="M6 16H4"/><path d="M28 16h-2"/><path d="M8 12l-2-2"/><path d="M24 12l2-2"/><path d="M4 24h24"/>`),
  battery: svg(`<path d="M8 12h16v12H8z"/><path d="M24 16h2v4h-2"/><path d="M12 16h8"/>`),
  fajr: svg(`<path d="M6 22h20"/><path d="M10 18a6 6 0 0112 0"/><path d="M16 8v6"/>`),
  plate: svg(`<circle cx="16" cy="18" r="9"/><path d="M6 30h20"/><path d="M23 10h4"/><path d="M25 8v8"/>`),
  sunset: svg(`<path d="M4 24h24"/><path d="M6 24a10 10 0 0120 0"/><path d="M16 10v6"/><path d="M6 14H4"/><path d="M28 14h-2"/>`),
  maghrib: svg(`<path d="M4 24h24"/><path d="M8 20a8 8 0 0116 0"/><path d="M10 12l-2-2"/><path d="M22 12l2-2"/>`),
  community: svg(`<path d="M10 15a3 3 0 106 0 3 3 0 10-6 0z"/><path d="M16 15a3 3 0 116 0 3 3 0 01-6 0z"/><path d="M6 28c0-4 4-6 7-6"/><path d="M26 28c0-4-4-6-7-6"/><path d="M13 22c2 0 4 1 3 6"/>`),
  prayer: svg(`<path d="M12 28c0-6 2-10 4-12s4-3 4-6"/><path d="M10 12a3 3 0 106 0 3 3 0 00-6 0z"/><path d="M18 10l6-3"/>`),
  clockNight: svg(`<circle cx="16" cy="16" r="10"/><path d="M16 11v6l4 3"/><path d="M6 6l4 4"/>`),
  read: svg(`<path d="M8 8h10a4 4 0 014 4v14H12a4 4 0 00-4 4V8z"/><path d="M20 8h4v18a4 4 0 00-4-4h-8"/>`),
  last10: svg(`<path d="M6 26h20"/><path d="M10 24V10h6v14"/><path d="M18 10h4a4 4 0 010 8h-4v8h4"/>`),
  power: svg(`<path d="M16 2l4 10h-3l3 10-8-12h4z"/><path d="M6 30h20"/>`),
  calendar: svg(`<path d="M8 6h16v22H8z"/><path d="M8 12h16"/><path d="M12 4v4"/><path d="M20 4v4"/><path d="M12 16h4M20 16h0"/><path d="M12 20h4M20 20h0"/>`),
  value: svg(`<path d="M8 10h20"/><path d="M8 16h14"/><path d="M8 22h20"/><path d="M6 8v18a2 2 0 002 2h18a2 2 0 002-2V8a2 2 0 00-2-2H8a2 2 0 00-2 2z"/>`),
  angels: svg(`<path d="M16 8c-4 0-8 3-8 8 0 7 8 12 8 12s8-5 8-12c0-5-4-8-8-8z"/><path d="M6 14c-2-1-3-3-3-5 3 0 5 1 6 3"/><path d="M26 14c2-1 3-3 3-5-3 0-5 1-6 3"/>`),
  dawn: svg(`<path d="M4 24h24"/><path d="M8 20a8 8 0 0116 0"/><path d="M16 8v6"/><path d="M12 10l-2-2"/><path d="M20 10l2-2"/>`),
  celebrate: svg(`<path d="M6 26l6-14 8 10 6-16"/><path d="M6 26h20"/><path d="M12 12l2 2"/>`),
  meaning: svg(`<path d="M10 6h12v6H10z"/><path d="M8 14h16v16H8z"/><path d="M12 18h8"/><path d="M12 22h6"/>`),
  greet: svg(`<path d="M6 10h20v12H14l-6 6v-6H6z"/><path d="M10 14h12"/><path d="M10 18h9"/>`),
  cave: svg(`<path d="M4 26c3-8 8-14 12-14s9 6 12 14H4z"/><path d="M12 22h8"/>`),
  night: svg(`<path d="M22 6c-4 2-6 7-4 12s7 6 12 4c-6 4-15 1-17-6S16 6 22 6z"/><path d="M8 8l2 4 4 2-4 2-2 4-2-4-4-2 4-2 2-4z"/>`),
  history: svg(`<path d="M16 6a10 10 0 1010 10"/><path d="M16 10v6l4 2"/><path d="M26 6v6h-6"/>`),
  angel: svg(`<path d="M16 10c-5 0-9 4-9 9 0 6 9 11 9 11s9-5 9-11c0-5-4-9-9-9z"/><path d="M6 16c-2 0-4-2-4-4 2 0 4 1 5 3"/><path d="M26 16c2 0 4-2 4-4-2 0-4 1-5 3"/>`),
  eid: svg(`<path d="M8 24c3-8 6-12 8-12s5 4 8 12"/><path d="M6 24h20"/><path d="M12 10l4-6 4 6"/>`)
};

function svg(paths){
  return `
  <svg width="28" height="28" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <g stroke="rgba(255,255,255,.92)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      ${paths}
    </g>
  </svg>`;
}

/* =========================================================
   3) Game Logic + UI (SMART SHUFFLE)
   ========================================================= */
const el = (id)=>document.getElementById(id);
const qTotalEl = el("qTotal");
const qIndexEl = el("qIndex");
const scoreEl  = el("score");
const progressBar = el("progressBar");
const lessonTag = el("lessonTag");
const diffTag = el("diffTag");
const qText = el("qText");
const qHint = el("qHint");
const answers = el("answers");
const qIcon = el("qIcon");
const startBtn = el("startBtn");

const overlay = el("overlay");
const helpBtn = el("helpBtn");
const closeModalBtn = el("closeModalBtn");
const restartBtn = el("restartBtn");
const modalTitle = el("modalTitle");
const modalText = el("modalText");

const musicBtn = el("musicBtn");
const musicLabel = el("musicLabel");
const sfxBtn = el("sfxBtn");
const sfxLabel = el("sfxLabel");

const pdfBtn = el("pdfBtn");

let index = -1;
let score = 0;
let locked = false;
let started = false;

// ‚úÖ Gate: must click Open PDF once
let pdfOpened = false;

// ‚úÖ Smart mode: correct position can't repeat twice in a row
let lastCorrectPos = -1;

qTotalEl.textContent = QUESTIONS.length;

function difficultyToTag(d){
  if(d==="Easy") return "‚≠ê Easy";
  if(d==="Medium") return "‚ú® Medium";
  return "üß† Thinking";
}

function setIcon(name){
  qIcon.innerHTML = ICONS[name] || "üéì";
}

function updateProgress(){
  const done = Math.max(0, index);
  const pct = started ? ((done)/QUESTIONS.length)*100 : 0;
  progressBar.style.width = `${pct}%`;
  qIndexEl.textContent = started ? (index+1) : 0;
  scoreEl.textContent = score;
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

function shuffleArray(arr){
  for(let i = arr.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

// Ensure correct answer position != lastCorrectPos
function smartShuffleChoices(item){
  const base = item.choices.map((text, originalIndex)=>({ text, originalIndex }));

  // Try reshuffling a few times
  let tries = 0;
  while(tries < 12){
    shuffleArray(base);
    const correctPos = base.findIndex(x => x.originalIndex === item.answerIndex);
    if(correctPos !== lastCorrectPos){
      lastCorrectPos = correctPos;
      return { shuffled: base, correctPos };
    }
    tries++;
  }

  // If still same (rare), force a swap
  let correctPos = base.findIndex(x => x.originalIndex === item.answerIndex);
  if(correctPos < 0) correctPos = 0;

  let swapWith = Math.floor(Math.random() * base.length);
  if(swapWith === correctPos) swapWith = (swapWith + 1) % base.length;

  [base[correctPos], base[swapWith]] = [base[swapWith], base[correctPos]];

  correctPos = base.findIndex(x => x.originalIndex === item.answerIndex);
  lastCorrectPos = correctPos;
  return { shuffled: base, correctPos };
}

function renderQuestion(){
  locked = false;
  const item = QUESTIONS[index];

  lessonTag.textContent = "üìò " + item.lesson;
  diffTag.textContent = difficultyToTag(item.difficulty);
  qText.textContent = item.q;
  qHint.textContent = "Choose the correct answer. You will auto-advance ‚úÖ";
  setIcon(item.icon);

  const { shuffled, correctPos } = smartShuffleChoices(item);
  item._renderCorrect = correctPos;

  answers.innerHTML = "";
  const labels = ["1","2","3","4"];

  shuffled.forEach((c, i)=>{
    const b = document.createElement("button");
    b.className = "btn";
    b.type = "button";
    b.setAttribute("data-i", i);
    b.innerHTML = `<span class="choiceLabel">${labels[i]}</span> ${escapeHtml(c.text)}`;
    b.addEventListener("click", ()=>choose(i, b));
    answers.appendChild(b);
  });

  updateProgress();
}

function choose(i, btn){
  if(locked) return;

  const item = QUESTIONS[index];
  const isCorrect = i === item._renderCorrect;

  [...answers.querySelectorAll(".btn")].forEach(b=>b.classList.remove("good","bad"));

  if(isCorrect){
    locked = true;
    score += (item.difficulty==="Easy" ? 1 : item.difficulty==="Medium" ? 2 : 3);
    btn.classList.add("good");
    playCorrect();
    sparkleBurst(btn, true);
    confetti(true);
    qHint.textContent = "Great job! ‚úÖ Next question...";
    updateProgress();

    setTimeout(()=>{ next(); }, 900);
  } else {
    btn.classList.add("bad");
    playWrong();
    sparkleBurst(btn, false);
    qHint.textContent = "Nice try! ‚ùå Keep trying until you get the correct one.";
  }
}

function next(){
  if(index+1 >= QUESTIONS.length){
    finish();
    return;
  }
  index++;
  renderQuestion();
}

function startGame(){
  started = true;
  score = 0;
  index = 0;
  lastCorrectPos = -1;
  startBtn.textContent = "üîÅ Restart";
  renderQuestion();
}

function finish(){
  started = false;
  progressBar.style.width = "100%";
  qIndexEl.textContent = QUESTIONS.length;
  scoreEl.textContent = score;

  showModal(
    "üéâ Well done! Game completed",
    `Your score: ${score} points.\n\nRemember: All questions are based ONLY on the uploaded PDF content.`
  );
}

/* =========================================================
   4) Visual FX (sparkles + canvas confetti)
   ========================================================= */
const canvas = document.getElementById("fx");
const ctx = canvas.getContext("2d");
let W=0,H=0;
function resize(){
  W = canvas.width = window.innerWidth * devicePixelRatio;
  H = canvas.height = window.innerHeight * devicePixelRatio;
}
window.addEventListener("resize", resize);
resize();

const particles = [];
function confetti(good){
  const count = 90;
  for(let i=0;i<count;i++){
    particles.push({
      x: (Math.random()*W),
      y: -20,
      vx: (Math.random()-0.5)*3*devicePixelRatio,
      vy: (2+Math.random()*4)*devicePixelRatio,
      r: (2+Math.random()*4)*devicePixelRatio,
      life: 60 + Math.random()*40,
      t: 0,
      good
    });
  }
}

function drawFx(){
  ctx.clearRect(0,0,W,H);
  for(let i=particles.length-1;i>=0;i--){
    const p = particles[i];
    p.t++;
    p.x += p.vx;
    p.y += p.vy;
    p.vy *= 0.99;
    p.vx *= 0.99;
    p.life--;

    ctx.globalAlpha = Math.max(0, p.life/100);
    ctx.fillStyle = p.good ? "rgba(34,197,94,0.9)" : "rgba(110,231,255,0.85)";
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
    ctx.fill();

    ctx.globalAlpha *= 0.7;
    ctx.strokeStyle = "rgba(255,255,255,0.7)";
    ctx.lineWidth = 1.2*devicePixelRatio;
    ctx.beginPath();
    ctx.moveTo(p.x - p.r*1.6, p.y);
    ctx.lineTo(p.x + p.r*1.6, p.y);
    ctx.moveTo(p.x, p.y - p.r*1.6);
    ctx.lineTo(p.x, p.y + p.r*1.6);
    ctx.stroke();

    if(p.life<=0 || p.y>H+50) particles.splice(i,1);
  }
  ctx.globalAlpha = 1;
  requestAnimationFrame(drawFx);
}
drawFx();

function sparkleBurst(targetEl, good){
  const rect = targetEl.getBoundingClientRect();
  const x0 = rect.left + rect.width/2;
  const y0 = rect.top + rect.height/2;

  for(let i=0;i<10;i++){
    const s = document.createElement("div");
    s.className = "sparkle";
    const dx = (Math.random()-0.5)*160;
    const dy = (Math.random()-0.5)*120;
    s.style.left = (x0 + (Math.random()-0.5)*20) + "px";
    s.style.top  = (y0 + (Math.random()-0.5)*10) + "px";
    s.style.setProperty("--dx", dx + "px");
    s.style.setProperty("--dy", dy + "px");
    s.style.filter = good
      ? "drop-shadow(0 0 10px rgba(34,197,94,.7))"
      : "drop-shadow(0 0 10px rgba(239,68,68,.65))";
    document.body.appendChild(s);
    setTimeout(()=>s.remove(), 950);
  }
}

/* =========================================================
   5) Audio: SFX + gentle background music (no external files)
   ========================================================= */
let audioCtx = null;
let sfxEnabled = true;
let musicEnabled = false;
let musicNodes = null;

function ensureAudio(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if(audioCtx.state === "suspended"){
    audioCtx.resume();
  }
}

function tone(freq, durationMs, type="sine", gain=0.06){
  if(!sfxEnabled) return;
  ensureAudio();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type;
  o.frequency.value = freq;
  g.gain.value = 0.0001;
  o.connect(g);
  g.connect(audioCtx.destination);
  o.start();

  const now = audioCtx.currentTime;
  g.gain.setValueAtTime(0.0001, now);
  g.gain.linearRampToValueAtTime(gain, now + 0.02);
  g.gain.exponentialRampToValueAtTime(0.0001, now + durationMs/1000);

  o.stop(now + durationMs/1000 + 0.02);
}

function playCorrect(){
  tone(523.25, 120, "triangle", 0.05);
  setTimeout(()=>tone(659.25, 140, "triangle", 0.05), 120);
  setTimeout(()=>tone(783.99, 160, "triangle", 0.05), 270);
}
function playWrong(){
  tone(220, 140, "sine", 0.055);
  setTimeout(()=>tone(196, 160, "sine", 0.055), 150);
}

function startMusic(){
  ensureAudio();
  if(musicNodes) return;

  const master = audioCtx.createGain();
  master.gain.value = 0.025;
  master.connect(audioCtx.destination);

  const o1 = audioCtx.createOscillator();
  const o2 = audioCtx.createOscillator();
  const g1 = audioCtx.createGain();
  const g2 = audioCtx.createGain();

  o1.type = "sine";
  o2.type = "triangle";
  o1.frequency.value = 220;
  o2.frequency.value = 277.18;
  g1.gain.value = 0.6;
  g2.gain.value = 0.4;

  o1.connect(g1); o2.connect(g2);
  g1.connect(master); g2.connect(master);

  const lfo = audioCtx.createOscillator();
  const lfoGain = audioCtx.createGain();
  lfo.type = "sine";
  lfo.frequency.value = 0.08;
  lfoGain.gain.value = 18;
  lfo.connect(lfoGain);
  lfoGain.connect(o2.frequency);

  o1.start(); o2.start(); lfo.start();
  musicNodes = {master,o1,o2,g1,g2,lfo,lfoGain};
}

function stopMusic(){
  if(!musicNodes || !audioCtx) return;
  const now = audioCtx.currentTime;
  musicNodes.master.gain.exponentialRampToValueAtTime(0.0001, now + 0.18);
  setTimeout(()=>{
    try{
      musicNodes.o1.stop();
      musicNodes.o2.stop();
      musicNodes.lfo.stop();
    }catch(e){}
    musicNodes = null;
  }, 220);
}

/* =========================================================
   6) Modal + PDF button + Restart
   ========================================================= */
function showModal(title, text){
  modalTitle.textContent = title;
  modalText.textContent = text;
  overlay.classList.add("show");
}
function closeModal(){
  overlay.classList.remove("show");
}

function openPdfNow(){
  // Must be called from a user gesture (click) to avoid popup blockers
  const win = window.open(PDF_URL, "_blank", "noopener,noreferrer");
  if(!win){
    showModal(
      "‚ö†Ô∏è Popup blocked",
      "Your browser blocked opening the PDF.\n\n1) Allow popups for this page.\n2) Or copy and open this link manually:\n\n" + PDF_URL
    );
    return false;
  }
  return true;
}

// ‚úÖ PDF Button
pdfBtn.addEventListener("click", ()=>{
  pdfOpened = true;
  openPdfNow();
});

helpBtn.addEventListener("click", ()=>{
  showModal("‚ùî Help",
`- Step 1: Click ‚ÄúOpen PDF‚Äù to read the material.
- Step 2: Click ‚ÄúStart Game‚Äù.
- Choose the correct answer to auto-advance.
- Wrong answers keep you on the same question until correct.
- Scoring: Easy=1, Medium=2, Thinking=3.
- Keyboard: 1‚Äì4 to answer, M for music, S for SFX.
- Smart mode: the correct answer will NOT repeat in the same position twice in a row.`);
});

closeModalBtn.addEventListener("click", closeModal);
overlay.addEventListener("click", (e)=>{
  if(e.target === overlay) closeModal();
});

restartBtn.addEventListener("click", ()=>{
  closeModal();
  startGame();
});

/* =========================================================
   7) Controls + Keyboard shortcuts
   ========================================================= */
startBtn.addEventListener("click", ()=>{
  ensureAudio();

  if(!pdfOpened){
    // Friendly: open PDF for them, then ask to start again
    showModal(
      "üìÑ Read first!",
      "I will open the PDF for you now.\n\nAfter you read, come back and press ‚ÄúStart Game‚Äù again."
    );
    // Try to open it (still user gesture here)
    openPdfNow();
    return;
  }

  startGame();
});

musicBtn.addEventListener("click", ()=>{
  ensureAudio();
  musicEnabled = !musicEnabled;
  musicBtn.setAttribute("aria-pressed", String(musicEnabled));
  musicLabel.textContent = musicEnabled ? "Music: On" : "Music: Off";
  if(musicEnabled) startMusic();
  else stopMusic();
});

sfxBtn.addEventListener("click", ()=>{
  ensureAudio();
  sfxEnabled = !sfxEnabled;
  sfxBtn.setAttribute("aria-pressed", String(sfxEnabled));
  sfxLabel.textContent = sfxEnabled ? "SFX: On" : "SFX: Off";
});

window.addEventListener("keydown", (e)=>{
  if(e.key.toLowerCase()==="m") musicBtn.click();
  if(e.key.toLowerCase()==="s") sfxBtn.click();
  if(!started) return;

  const k = e.key;
  if(["1","2","3","4"].includes(k)){
    const i = parseInt(k,10)-1;
    const btn = answers.querySelector(`.btn[data-i="${i}"]`);
    if(btn) btn.click();
  }
});

/* Nice initial state */
updateProgress();
setIcon("moon");
qText.textContent = "Step 1: Click ‚ÄúOpen PDF‚Äù üìÑ  ‚Ä¢  Step 2: Click ‚ÄúStart Game‚Äù üåô";
qHint.textContent = "Smart mode: the correct answer won‚Äôt repeat in the same position twice in a row ‚úÖ";
</script>
</body>
</html>
